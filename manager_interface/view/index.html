<%
	Request.Execute('\\portal\\bs\\portal_bootstrap\\execute\\init_app.html');
%>

﻿<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Интерфейс руководителя</title>
    <% ac = Random(1,999) %>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
		<%=init_static([
			{
				name: 'jq'
				,v: '340'
			},{
				name: 'jqui'
				,v: '1121'
			},{
				name: 'dt'
				,v: '11018'
			},{
				name: 'bs'
				,v: '4'
			},{
				name: 'bss'
				,v: '1139'
			},{
				name: 'ajm'
				,v: '0'
			}
		]);%>
    <!-- Other scripts -->
    <script type="text/javascript" src="http://<%=Request.UrlHost%>/portal/bs/portal_bootstrap/scripts/jszip.min.js?<%=ac%>"></script>
    <script type="text/javascript" src="http://<%=Request.UrlHost%>/portal/bs/portal_bootstrap/scripts/doms/context_menus.js?<%=ac%>"></script>
    <!-- Custom CSS -->
    <style media="screen">
      @font-face {font-family: 'SvyaznoySans'; src: url(http://<%=Request.UrlHost%>/portal/bs/portal_bootstrap/scripts/fonts/SvyaznoySans-Medium.otf);}
      body {font-family: 'SvyaznoySans'!important; font-weight: 100;}
      table {width: 100%; margin-top: 2%; text-align: center; border-radius: 10px; border-collapse: separate; border-spacing: 5px; letter-spacing: 2px;}
      table thead tr {color: #ffffff; background: #a770ef;font-size: 16px; font-weight: normal;}
      table thead tr th {text-align: center;}
      table tbody tr {cursor: pointer; font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif; font-weight: 400}
      table#myEmployees tbody tr:hover {background: #ffe8e8; transition-duration: 0.6s;}
      table tr td {border-right: 1px solid #dfdfdf;}
      table tr td:last-child {border-right: 0px;}
      table tbody tr:nth-child(1n) {background: #f6f6f6;}
      table tbody tr:nth-child(2n) {background: #e6e6e6;}
      .sorting_asc, .sorting_desc, .sorting {text-align: center; font-weight: normal; letter-spacing: 3px; font-size: 13px; text-transform: uppercase;}
      #close {
        position: absolute;
        margin-left: 30px;
        top: 32px;
        width: 10px;
        height: 10px;
        opacity: 0.3;
      }
      #close:hover {
        opacity: 1;
      }
      #close:before, #close:after {
        position: absolute;
        left: 15px;
        content: ' ';
        height: 33px;
        width: 2px;
        background-color: #333;
      }
      #close:before {
        transform: rotate(45deg);
      }
      #close:after {
        transform: rotate(-45deg);
      }
    </style>

    <!-- Custom JS -->
    <script type="text/javascript">
      const _APPDIR = "http://<%=Request.UrlHost%>/portal/bs/portal_bootstrap/manager_interface/";
      const USER = "<%=Request.AuthUserID%>";

      let CNTXMN = [];

      CNTXMN.push(new contextMenuElement(
          'assesment'
          ,'Оценка персонала'
          ,function( a ) {
            console.log(a);
            $('<div>', {id: 'hover-block', css: {
              'position': 'fixed'
              ,'top': 0
              ,'left': 0
              ,'background-color': 'rgba(0,0,0,0.5)'
              ,'height' : '100%'
              ,'width' : '100%'
              ,'z-index' : 50
              }
            }).appendTo('body');

            $('#hover-block').append(
              $('<div>', {
                id: 'sheet'
                ,css: {
                  'width': '50%'
                  ,'margin': '0 auto'
                  ,'background-color': '#fefefe'
                  ,'border-radius': '2px'
                  ,'position': 'relative'
                  ,'top':  window.innerHeight/3
                  ,'padding': '20px'
                }
              })
            );

            let currentObject = {
              fullname: $(`#${a[0].ID}`).children()[0].innerText
              ,position_name: $(`#${a[0].ID}`).children()[1].innerText
            }



            let domTable = $('<div>', {
              'class': 'row'
            }).append([
              $('<h4>', {
                css: {
                  'padding': '20px'
                  ,'margin': '15px'
                  ,'text-align': 'center'
                  ,'background-color': 'rgb(207, 139, 243, 0.3)'
                  ,'border-radius': '4px'
              }}).append(`${currentObject.fullname}, ${currentObject.position_name}`)
              ,$('<div>', {'class': "col-sm-10" })
              ,$('<div>', { 'class': "col-sm-2" })
            ]);

            $(domTable).children('.col-sm-10').append($('<select>', {
              'class': 'selectpicker'
              ,'data-live-search': "true"
              ,'data-width': "100%"
              ,css: {
                'position': 'relative'
                ,'z-index': 51
              }
            }).append($('<option>', {
              'selected': true
              ,'disabled': true
              ,'value': 0
            }).append('Выберите форму оценки')));

            $.ajax({
              url: _APPDIR + 'api/get_lists.html'
              ,contentType: 'application/json'
              ,dataType: 'json'
              ,success: function(JSONData) {
                console.log(JSONData);
                for (row in JSONData) {
                  let r = JSONData[row];
                  $('#sheet .selectpicker').append($('<option>', { 'value': r.id }).append(r.name));
                }
                $('#sheet .selectpicker').selectpicker('refresh')
              }
            });

            $(domTable).children('.col-sm-2').append($('<button>', {
              'class': 'btn btn-info btn-m pull-right'
              ,'type': 'button'
              ,'id': 'redirect'
            }).append('Оценить'));

            $("#sheet").append( domTable );

            $('#redirect').on('click', function() {
              window.open(`${window.location.origin}/view_doc.html?mode=list_view&list_id=${list_data.val()}&evaluated=${a[0].ID}`, 'edit', "");
            });

            let sp_dom = $('#sheet .selectpicker').selectpicker();

            let list_data = $('#sheet .selectpicker');

            $(document).keyup(function(e) {
              if (e.keyCode === 27) {
                $('#hover-block').remove();
              }
            });

            $('#hover-block').on('click', function(e){
              if (e.originalEvent.path[0].id == 'hover-block') {
                $('#hover-block').remove();
              }
            });

            })
      );

      CNTXMN.push(new contextMenuElement(
          'console'
          ,'Консольнуть'
          ,function( a ) {
            for (i in a) {
              console.log(a[i].data);
            }
          }
          ,""
        )
      );

      $(document).ready(function() {

        $('#myEmployees').dataTable().fnDestroy();

        let C = new TableContextMenu(CNTXMN);
        C.__init__();

        var employees = $('#myEmployees').DataTable({
          "ajax" : {
            "url": _APPDIR + "api/get_employees.html"
            ,"method" : "POST"
            ,"data": {
              "manager_id" : USER
            }
            ,dataSrc: "data"
          }
          ,rowId: 'a'
          ,dom: 'Bfrtip'
          ,buttons: []
          ,"columns": [
            {data: "b"}
            ,{data: "c"}
            ,{data: "d"}
          ]
        });

      });

  </script>
  </head>
  <body>
    <div class="row">
      <div class="form-group col-sm-12">
        <table id="myEmployees" class="table">
          <thead>
            <tr>
              <th>ФИО</th>
              <th>Должность</th>
              <th>Подразделение</th>
            </tr>
          </thead>
        </table>
      </div>
    </div>
    <script type="text/javascript">
    </script>
  </body>
</html>
